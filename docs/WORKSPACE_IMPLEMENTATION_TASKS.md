# Workspace 实施任务清单

## 概述
本文档详细规划了 Workspace 功能的完整实施流程，包含开发任务、验证步骤和集成测试。每个任务都有明确的验收标准和验证方法，确保实施质量。

## 任务执行原则
- ✅ 每个开发任务完成后必须通过对应的验证任务
- ✅ 验证失败必须修复后才能进入下一个开发任务
- ✅ 所有任务完成后必须通过集成测试
- ✅ 每个任务都要更新此文档的完成状态

---

## Phase 1: 数据层与基础 API

### Task 1.1: 环境配置与依赖安装
**目标**: 配置 Supabase 连接和必要的依赖包

**开发任务**:
- [ ] 安装 Supabase 客户端依赖: `@supabase/supabase-js`
- [ ] 配置环境变量 `.env.local`
- [ ] 创建 Supabase 客户端文件
  - [ ] `lib/supabase/server.ts` (服务端)
  - [ ] `lib/supabase/client.ts` (浏览器端)

**验收标准**:
- [ ] 依赖包正确安装且无版本冲突
- [ ] 环境变量配置完整且敏感信息不泄露
- [ ] 客户端文件可正常导入且类型正确

---

### Task 1.1-V: 验证环境配置
**验证内容**:
- [ ] 创建测试文件验证 Supabase 连接
- [ ] 服务端客户端能成功连接数据库
- [ ] 浏览器端客户端能正常初始化
- [ ] 运行 `npm run build` 无错误
- [ ] 运行 `npm run lint` 无错误

**验证脚本**:
```bash
# 创建临时测试文件
echo "Testing Supabase connection..."
node -e "
const { createClient } = require('@supabase/supabase-js');
const client = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);
console.log('✅ Supabase client created successfully');
"
```

**通过标准**: 所有验证项目都返回成功

---

### Task 1.2: 数据库表结构创建
**目标**: 在 Supabase 中创建项目相关的表结构

**开发任务**:
- [ ] 在 Supabase Dashboard 中执行 SQL 创建表:
  - [ ] `public.projects` (项目元数据)
  - [ ] `public.project_state` (运行态引用)
  - [ ] `public.project_snapshots` (快照列表)
  - [ ] `public.project_manifests` (文件清单缓存)
- [ ] 创建 Storage buckets:
  - [ ] `project-zips` (ZIP 文件存储)
  - [ ] `project-screenshots` (预览截图存储)
- [ ] 配置基础 RLS 策略 (先允许匿名访问用于开发)

**验收标准**:
- [ ] 所有表成功创建且字段类型正确
- [ ] 外键约束正确设置
- [ ] Storage buckets 创建成功且权限配置正确
- [ ] RLS 策略允许开发环境正常访问

---

### Task 1.2-V: 验证数据库结构
**验证内容**:
- [ ] 查询所有表结构，确认字段完整性
- [ ] 测试外键约束 (插入/删除操作)
- [ ] 测试 Storage 上传/下载权限
- [ ] 验证 RLS 策略是否生效

**验证 SQL**:
```sql
-- 验证表结构
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name IN ('projects', 'project_state', 'project_snapshots', 'project_manifests');

-- 测试外键约束
INSERT INTO public.projects (name) VALUES ('test-project');
INSERT INTO public.project_state (project_id) VALUES ((SELECT id FROM public.projects WHERE name = 'test-project'));

-- 清理测试数据
DELETE FROM public.projects WHERE name = 'test-project';
```

**通过标准**: 所有查询成功执行，约束正常工作

---

### Task 1.3: TypeScript 类型定义
**目标**: 创建项目相关的 TypeScript 类型定义

**开发任务**:
- [ ] 创建 `types/project.ts`
  - [ ] `Project` 接口
  - [ ] `ProjectState` 接口  
  - [ ] `ProjectSnapshot` 接口
  - [ ] `ProjectManifest` 接口
  - [ ] `CreateProjectRequest` 接口
  - [ ] `ProjectListResponse` 接口
- [ ] 导出所有类型到 `types/index.ts`

**验收标准**:
- [ ] 类型定义与数据库表结构一致
- [ ] 所有必需字段标记为非可选
- [ ] 可选字段正确标记
- [ ] 类型文件无 TypeScript 错误

---

### Task 1.3-V: 验证类型定义
**验证内容**:
- [ ] 创建测试组件使用所有定义的类型
- [ ] 验证类型推导是否正确
- [ ] 检查是否有未使用的类型定义
- [ ] 运行 TypeScript 编译检查

**验证代码**:
```typescript
// 创建临时测试文件验证类型
import { Project, ProjectState, CreateProjectRequest } from '@/types/project';

const testProject: Project = {
  id: 'test-id',
  name: 'Test Project',
  visibility: 'private',
  model: 'moonshotai/kimi-k2-instruct',
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  last_opened_at: null
};

console.log('✅ Type definitions working correctly');
```

**通过标准**: TypeScript 编译无错误，类型推导正确

---

### Task 1.4: 项目 CRUD API 开发
**目标**: 开发项目的增删改查 API

**开发任务**:
- [ ] 创建 `app/api/projects/route.ts`
  - [ ] `GET /api/projects` - 获取项目列表
  - [ ] `POST /api/projects` - 创建新项目
- [ ] 创建 `app/api/projects/[id]/route.ts`
  - [ ] `GET /api/projects/[id]` - 获取项目详情
  - [ ] `PATCH /api/projects/[id]` - 更新项目信息
  - [ ] `DELETE /api/projects/[id]` - 删除项目
- [ ] 实现错误处理和参数验证
- [ ] 添加请求日志记录

**验收标准**:
- [ ] 所有 API 端点正确响应
- [ ] 参数验证完整且错误信息清晰
- [ ] 数据库操作正确执行
- [ ] 错误处理覆盖所有异常情况

---

### Task 1.4-V: 验证项目 CRUD API
**验证内容**:
- [ ] 使用 Postman/curl 测试所有 API 端点
- [ ] 测试正常流程和异常流程
- [ ] 验证数据格式和类型正确性
- [ ] 测试边界条件和错误处理

**验证脚本**:
```bash
# 测试创建项目
curl -X POST http://localhost:3000/api/projects \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Project","model":"moonshotai/kimi-k2-instruct"}'

# 测试获取项目列表
curl http://localhost:3000/api/projects

# 测试获取项目详情
curl http://localhost:3000/api/projects/{PROJECT_ID}

# 测试更新项目
curl -X PATCH http://localhost:3000/api/projects/{PROJECT_ID} \
  -H "Content-Type: application/json" \
  -d '{"name":"Updated Project Name"}'

# 测试删除项目
curl -X DELETE http://localhost:3000/api/projects/{PROJECT_ID}
```

**通过标准**: 所有测试返回预期结果，数据库状态正确

---

## Phase 2: 沙箱管理与快照功能

### Task 2.1: 项目打开 API 开发
**目标**: 实现项目打开时的沙箱管理逻辑

**开发任务**:
- [ ] 创建 `app/api/projects/[id]/open/route.ts`
- [ ] 实现沙箱连接逻辑:
  - [ ] 尝试连接现有沙箱
  - [ ] 失效时创建新沙箱
  - [ ] 从快照还原项目文件
- [ ] 更新 `project_state` 表记录
- [ ] 实现基础 Vite 环境创建逻辑

**验收标准**:
- [ ] 能成功打开新项目（创建沙箱）
- [ ] 能重新打开现有项目（复用/重建沙箱）
- [ ] 沙箱状态正确记录到数据库
- [ ] 错误情况能正确处理和回滚

---

### Task 2.1-V: 验证项目打开功能
**验证内容**:
- [ ] 测试新项目打开流程
- [ ] 测试现有项目重新打开
- [ ] 测试沙箱连接失败的恢复逻辑
- [ ] 验证数据库状态更新正确性

**验证步骤**:
1. 创建新项目并打开
2. 检查 E2B 沙箱是否成功创建
3. 验证预览 URL 是否可访问
4. 检查 `project_state` 表数据
5. 模拟沙箱失效并重新打开项目

**通过标准**: 所有场景都能正确处理，沙箱状态一致

---

### Task 2.2: 快照创建 API 开发
**目标**: 实现项目快照的创建和存储

**开发任务**:
- [ ] 创建 `app/api/projects/[id]/snapshot/route.ts`
- [ ] 复用现有 `create-zip` 逻辑打包项目
- [ ] 实现 Supabase Storage 上传
- [ ] 计算文件 SHA256 哈希
- [ ] 记录快照信息到 `project_snapshots` 表
- [ ] 实现快照清理逻辑（保留最近 N 个）

**验收标准**:
- [ ] 能成功创建项目快照
- [ ] ZIP 文件正确上传到 Storage
- [ ] 快照元数据正确记录
- [ ] 文件哈希计算正确
- [ ] 旧快照能正确清理

---

### Task 2.2-V: 验证快照功能
**验证内容**:
- [ ] 测试快照创建流程
- [ ] 验证 ZIP 文件内容完整性
- [ ] 测试快照恢复功能
- [ ] 验证 Storage 权限和访问

**验证步骤**:
1. 在项目中创建一些文件
2. 调用快照 API 创建快照
3. 下载快照文件并解压验证内容
4. 检查数据库中的快照记录
5. 测试从快照恢复项目

**通过标准**: 快照创建成功，内容完整，能正确恢复

---

### Task 2.3: 沙箱状态管理 API
**目标**: 提供沙箱状态查询和管理功能

**开发任务**:
- [ ] 创建 `app/api/projects/[id]/status/route.ts`
- [ ] 实现沙箱状态检查
- [ ] 返回沙箱过期时间
- [ ] 提供快照列表信息
- [ ] 实现沙箱健康检查

**验收标准**:
- [ ] 能正确返回沙箱运行状态
- [ ] 过期时间计算准确
- [ ] 快照信息完整
- [ ] 响应时间合理（< 2s）

---

### Task 2.3-V: 验证状态管理功能
**验证内容**:
- [ ] 测试状态 API 响应准确性
- [ ] 验证沙箱健康检查逻辑
- [ ] 测试过期时间计算
- [ ] 性能测试和响应时间

**通过标准**: 状态信息准确，响应及时，无性能问题

---

### Task 2.4: 热迁移 API 开发
**目标**: 实现沙箱到期前的自动迁移

**开发任务**:
- [ ] 创建 `app/api/projects/[id]/clone-sandbox/route.ts`
- [ ] 实现旧沙箱打包逻辑
- [ ] 实现新沙箱创建和还原
- [ ] 实现平滑切换（更新项目状态）
- [ ] 实现旧沙箱清理
- [ ] 添加迁移状态跟踪

**验收标准**:
- [ ] 迁移过程无数据丢失
- [ ] 新沙箱功能完全正常
- [ ] 迁移时间控制在合理范围内
- [ ] 失败时能正确回滚

---

### Task 2.4-V: 验证热迁移功能
**验证内容**:
- [ ] 测试完整迁移流程
- [ ] 验证数据完整性
- [ ] 测试迁移失败的回滚机制
- [ ] 性能和稳定性测试

**验证步骤**:
1. 在旧沙箱中创建复杂项目状态
2. 触发热迁移
3. 验证新沙箱中的项目状态
4. 测试新沙箱的所有功能
5. 确认旧沙箱已正确清理

**通过标准**: 迁移成功率 100%，数据完整性保证

---

## Phase 3: 前端界面开发

### Task 3.1: Workspace 首页开发
**目标**: 改造首页为项目管理界面

**开发任务**:
- [ ] 重构 `app/page.tsx` 为 Workspace 界面
- [ ] 创建项目卡片组件 `components/ProjectCard.tsx`
- [ ] 创建新建项目组件 `components/CreateProjectModal.tsx`
- [ ] 实现项目列表加载和展示
- [ ] 添加项目操作菜单（重命名、删除、克隆）
- [ ] 实现响应式布局

**验收标准**:
- [ ] 界面美观且符合设计规范
- [ ] 所有项目操作功能正常
- [ ] 响应式布局在各设备正常显示
- [ ] 加载状态和错误状态处理完善

---

### Task 3.1-V: 验证 Workspace 界面
**验证内容**:
- [ ] 界面功能完整性测试
- [ ] 响应式布局测试
- [ ] 用户交互体验测试
- [ ] 错误处理和边界情况测试

**验证清单**:
- [ ] 能正确显示项目列表
- [ ] 新建项目功能正常
- [ ] 项目卡片点击能正确跳转
- [ ] 项目操作菜单功能完整
- [ ] 移动端界面适配良好
- [ ] 加载和错误状态显示正确

**通过标准**: 所有界面功能正常，用户体验良好

---

### Task 3.2: 项目详情页开发
**目标**: 创建项目专用的开发界面

**开发任务**:
- [ ] 创建 `app/projects/[id]/page.tsx`
- [ ] 提取现有编辑器组件为可复用组件
- [ ] 实现项目自动打开逻辑
- [ ] 添加项目信息显示（名称、状态等）
- [ ] 实现项目设置面板
- [ ] 添加快照管理界面

**验收标准**:
- [ ] 项目详情页正确加载
- [ ] 编辑器功能完全正常
- [ ] 项目信息准确显示
- [ ] 设置和快照管理功能完整

---

### Task 3.2-V: 验证项目详情页
**验证内容**:
- [ ] 页面加载和渲染测试
- [ ] 编辑器功能完整性测试
- [ ] 项目信息准确性验证
- [ ] 设置和快照功能测试

**验证步骤**:
1. 通过 URL 直接访问项目详情页
2. 验证项目自动打开和沙箱加载
3. 测试所有编辑器功能
4. 验证项目信息显示正确
5. 测试快照创建和恢复

**通过标准**: 所有功能正常，体验流畅

---

### Task 3.3: URL 路由重构
**目标**: 实现新的 URL 方案，隐藏内部参数

**开发任务**:
- [ ] 移除 URL 中的 `sandbox` 和 `model` 参数
- [ ] 实现项目 ID 路由 `/projects/[id]`
- [ ] 更新所有内部链接和跳转
- [ ] 实现 URL 重定向逻辑（兼容旧链接）
- [ ] 更新浏览器历史管理

**验收标准**:
- [ ] 新 URL 方案完全生效
- [ ] 旧 URL 能正确重定向
- [ ] 浏览器前进后退功能正常
- [ ] 分享链接功能正常

---

### Task 3.3-V: 验证 URL 路由
**验证内容**:
- [ ] 新 URL 访问测试
- [ ] 旧 URL 重定向测试
- [ ] 浏览器导航功能测试
- [ ] 分享和书签功能测试

**验证场景**:
- [ ] 直接访问 `/projects/{id}` 
- [ ] 访问旧格式 URL 并验证重定向
- [ ] 测试浏览器前进后退
- [ ] 测试页面刷新
- [ ] 测试链接分享

**通过标准**: 所有 URL 场景都能正确处理

---

## Phase 4: 系统集成与优化

### Task 4.1: AI 路由适配
**目标**: 修改现有 AI 相关 API 以支持项目上下文

**开发任务**:
- [ ] 修改 `app/api/generate-ai-code-stream/route.ts`
  - [ ] 接收 `projectId` 参数
  - [ ] 从数据库获取沙箱信息
  - [ ] 实现沙箱自动恢复逻辑
- [ ] 修改 `app/api/apply-ai-code/route.ts`
- [ ] 修改 `app/api/apply-ai-code-stream/route.ts`
- [ ] 修改 `app/api/analyze-edit-intent/route.ts`
- [ ] 更新所有相关的辅助 API

**验收标准**:
- [ ] 所有 AI 功能基于项目 ID 正常工作
- [ ] 沙箱自动恢复机制稳定
- [ ] 向后兼容性保持良好
- [ ] 性能没有明显下降

---

### Task 4.1-V: 验证 AI 路由集成
**验证内容**:
- [ ] AI 代码生成功能测试
- [ ] 代码应用功能测试
- [ ] 编辑意图分析测试
- [ ] 沙箱恢复逻辑测试

**验证流程**:
1. 创建新项目并添加初始内容
2. 使用 AI 生成代码功能
3. 应用生成的代码
4. 模拟沙箱失效并重新生成代码
5. 验证所有功能在项目上下文中正常工作

**通过标准**: 所有 AI 功能在新架构下正常运行

---

### Task 4.2: 自动化策略实现
**目标**: 实现自动快照和热迁移机制

**开发任务**:
- [ ] 实现定时快照策略
  - [ ] 基于文件变化的智能快照
  - [ ] 快照频率控制和节流
- [ ] 实现自动热迁移
  - [ ] 沙箱到期监控
  - [ ] 自动迁移触发
  - [ ] 迁移状态通知
- [ ] 实现快照清理策略
- [ ] 添加系统监控和日志

**验收标准**:
- [ ] 自动快照按策略正确执行
- [ ] 热迁移自动触发且成功率高
- [ ] 快照存储空间控制在合理范围
- [ ] 系统资源使用合理

---

### Task 4.2-V: 验证自动化功能
**验证内容**:
- [ ] 自动快照策略测试
- [ ] 热迁移自动触发测试
- [ ] 系统资源使用监控
- [ ] 长时间稳定性测试

**验证方法**:
1. 长时间运行项目并观察自动快照
2. 模拟沙箱到期触发自动迁移
3. 监控系统资源使用情况
4. 检查日志记录的完整性

**通过标准**: 自动化功能稳定可靠，资源使用合理

---

### Task 4.3: 性能优化
**目标**: 优化系统性能和用户体验

**开发任务**:
- [ ] 实现项目列表分页和虚拟滚动
- [ ] 优化快照上传和下载性能
- [ ] 实现沙箱状态缓存
- [ ] 优化数据库查询性能
- [ ] 实现前端状态管理优化
- [ ] 添加性能监控指标

**验收标准**:
- [ ] 页面加载时间 < 3s
- [ ] 大量项目下界面响应流畅
- [ ] 快照操作时间合理
- [ ] 数据库查询优化显著

---

### Task 4.3-V: 验证性能优化
**验证内容**:
- [ ] 页面加载性能测试
- [ ] 大数据量下的界面性能
- [ ] 网络请求优化效果验证
- [ ] 数据库性能基准测试

**性能指标**:
- [ ] 首页加载时间 < 3s
- [ ] 项目详情页打开时间 < 5s
- [ ] 100 个项目下界面依然流畅
- [ ] 快照创建时间 < 30s
- [ ] API 响应时间 < 2s

**通过标准**: 所有性能指标达到要求

---

## 集成测试 (Phase 5)

### Task 5.1: 端到端功能测试
**目标**: 验证完整的用户使用流程

**测试场景**:
- [ ] **新用户首次使用流程**
  1. 访问首页看到空的 Workspace
  2. 创建第一个项目
  3. 进入项目开始开发
  4. 使用 AI 生成代码
  5. 保存快照
  6. 退出并重新打开项目

- [ ] **多项目管理流程**
  1. 创建多个不同类型的项目
  2. 在项目间切换
  3. 重命名和删除项目
  4. 验证项目独立性

- [ ] **沙箱生命周期流程**
  1. 项目开发过程中沙箱正常运行
  2. 模拟沙箱即将过期
  3. 自动热迁移执行
  4. 验证迁移后功能正常

**验收标准**: 所有场景都能顺利完成，无功能缺失

---

### Task 5.2: 错误处理和边界测试
**目标**: 验证系统的健壮性

**测试场景**:
- [ ] **网络异常处理**
  - 网络中断时的用户体验
  - 网络恢复后的状态同步
  - API 超时的处理

- [ ] **数据异常处理**
  - 无效的项目 ID 访问
  - 损坏的快照文件
  - 数据库连接异常

- [ ] **资源限制测试**
  - 大量项目的性能表现
  - 大文件快照的处理
  - 并发用户的系统表现

**验收标准**: 所有异常情况都有优雅的处理

---

### Task 5.3: 兼容性和迁移测试
**目标**: 验证新系统与现有功能的兼容性

**测试内容**:
- [ ] **旧 URL 重定向测试**
  - 旧格式链接能正确重定向
  - 书签和分享链接依然有效

- [ ] **功能完整性对比**
  - 对比新旧系统功能清单
  - 验证所有原有功能都已迁移
  - 确认新功能正常工作

- [ ] **数据迁移测试** (如果需要)
  - 现有项目数据能正确迁移
  - 迁移过程无数据丢失

**验收标准**: 100% 向后兼容，功能无缺失

---

### Task 5.4: 安全性测试
**目标**: 验证系统的安全性

**测试内容**:
- [ ] **权限控制测试**
  - 未授权访问的拦截
  - API 权限验证
  - 敏感信息保护

- [ ] **数据安全测试**
  - 项目数据隔离性
  - 快照文件访问控制
  - 环境变量安全性

**验收标准**: 无安全漏洞，权限控制严密

---

### Task 5.5: 用户体验测试
**目标**: 验证整体用户体验

**测试维度**:
- [ ] **易用性测试**
  - 新用户学习成本
  - 界面直观性
  - 操作流畅性

- [ ] **稳定性测试**
  - 长时间使用稳定性
  - 异常恢复能力
  - 数据一致性

- [ ] **性能体验测试**
  - 响应速度满意度
  - 加载体验流畅度
  - 资源使用合理性

**验收标准**: 用户体验显著提升，无明显痛点

---

## 完成检查清单

### 开发完成度检查
- [ ] 所有开发任务已完成
- [ ] 所有验证任务通过
- [ ] 代码质量检查通过
- [ ] 文档更新完整

### 功能完整性检查
- [ ] 项目 CRUD 功能完整
- [ ] 沙箱管理功能正常
- [ ] 快照功能稳定可靠
- [ ] AI 集成功能正常
- [ ] 自动化策略有效

### 质量保证检查
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] 性能指标达标
- [ ] 安全测试通过
- [ ] 用户体验测试满意

### 部署准备检查
- [ ] 环境配置文档完整
- [ ] 部署脚本准备就绪
- [ ] 监控和日志配置
- [ ] 回滚方案准备

---

## 风险和应对方案

### 技术风险
- **E2B API 变更**: 密切关注 E2B 更新，准备适配方案
- **Supabase 服务稳定性**: 准备本地数据库备用方案
- **性能瓶颈**: 提前进行负载测试，准备优化方案

### 进度风险
- **任务复杂度超预期**: 及时调整任务拆分粒度
- **依赖服务延迟**: 准备 Mock 服务进行并行开发

### 质量风险
- **功能回归**: 严格执行验证任务，确保质量
- **用户体验下降**: 持续进行用户体验测试

---

## 总结

本任务文档共包含 **23 个开发任务** + **23 个验证任务** + **5 个集成测试任务**，总计 **51 个任务**。

执行顺序严格按照：**开发任务 → 对应验证任务 → 下一个开发任务**，最后完成集成测试。

预计总工期：**2-3 周**（取决于团队规模和并行度）

每个任务完成后请在对应的 `[ ]` 中标记 `[x]` 并更新文档。

